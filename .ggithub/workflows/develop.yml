name: Develop
on:
  push:
    branches: [ develop ]
jobs:
  update:
    name: checkout
    runs-on: ubuntu-latest
    environment:
      name: development
    steps:
    - name: 'Set env file'
      id: envfile
      uses: fifsky/ssh-action@master
      with:
        command: |
          echo dev >> ~/run/env
          cd dev/${{ github.event.repository.name }}
          touch .env.development
          rm -f .env.development

          echo NODE_ENV=${{ vars.NODE_ENV }} >> .env.development
          echo API_PORT=${{ vars.INTERNAL_APP_PORT }} >> .env.development
          echo ENABLE_CORS=${{ vars.ENABLE_CORS }} >> .env.development

          echo DB_TYPE=${{ vars.DB_TYPE }} >> .env.development
          echo DB_NAME=${{ vars.DB_NAME }} >> .env.development
          echo DB_PORT=${{ vars.DB_PORT }} >> .env.development
          echo DB_PASSWORD=${{ secrets.DB_PASSWORD }} >> .env.development
          echo DB_USER=${{ vars.DB_USER }} >> .env.development
          echo DB_HOST=${{ vars.DB_HOST }} >> .env.development
          echo DB_SSL=${{ vars.DB_SSL }} >> .env.development

          echo JWT_SECRET=${{ secrets.JWT_SECRET }} >> .env.development
          echo JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }} >> .env.development

          echo ACCESS_TOKEN_EXPIRATION=${{ vars.ACCESS_TOKEN_EXPIRATION }} >> .env.development
          echo REFRESH_TOKEN_EXPIRATION=${{ vars.REFRESH_TOKEN_EXPIRATION }} >> .env.development

          cat .env.development
        host: ${{ vars.HOST }}
        user: ${{ vars.SSH_USER }}
        key: ${{ secrets.SECRET_KEY }}
    - name: Updating repository
      id: checkout
      uses: fifsky/ssh-action@master
      with:
        command: |
          cd dev/${{ github.event.repository.name }}
          printf "\n\n updating repository....\n\n "
          git reset --hard origin/develop
          git pull origin develop

          echo "$(docker inspect --format="{{.Image}}" $(docker ps -a --format "table {{.Names}}" | grep containerdev ))" > old_image_id.txt

          echo "old image: $(head -1 old_image_id.txt)"
        host: ${{ vars.HOST }}
        user: ${{ vars.SSH_USER }}
        key: ${{ secrets.SECRET_KEY }}

  build:
    name: build
    needs: update
    runs-on: ubuntu-latest
    environment:
      name: development
    steps:
    - name: building image
      uses: fifsky/ssh-action@master
      with:
        command: |
          cd dev/${{ github.event.repository.name }}

          printf "\n\n generating docker image....\n\n "
          docker build -t ${{ github.event.repository.name }}:dev .

          echo "$(docker images --filter "reference=${{ github.event.repository.name }}:dev" --format {{.ID}})" > new_image_id.txt

          echo "new image: $(head -1 new_image_id.txt)"
        host: ${{ vars.HOST }}
        user: ${{ vars.SSH_USER }}
        key: ${{ secrets.SECRET_KEY }}

  deploy-dev:
    name: deploy-dev
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: development
      url: http://${{ vars.HOST }}:${{ vars.EXTERNAL_APP_PORT }}/
    steps:
    - name: starting server
      uses: fifsky/ssh-action@master
      with:
        command: |
          cd dev/${{ github.event.repository.name }}

          docker stop containerdev
          docker rm containerdev

          printf "\n\n starting docker server on port ${{ vars.EXTERNAL_APP_PORT }} ....\n\n "
          docker run -d -p ${{ vars.EXTERNAL_APP_PORT }}:${{ vars.INTERNAL_APP_PORT }} -e NODE_ENV="dev" --name containerdev --restart=always $(head -1 new_image_id.txt)

        host: ${{ vars.HOST }}
        user: ${{ vars.SSH_USER }}
        key: ${{ secrets.SECRET_KEY }}

    - name: restart last container
      uses: fifsky/ssh-action@master

      if: ${{ failure() }}
      with:
        command: |
          cd dev/${{ github.event.repository.name }}

          printf "\n\n restarting docker server on port ${{ vars.EXTERNAL_APP_PORT }} ....\n\n "
          docker run -d -p ${{ vars.EXTERNAL_APP_PORT }}:${{ vars.INTERNAL_APP_PORT }} -e NODE_ENV="dev" --name containerdev --restart=always $(head -1 old_image_id.txt)

          docker rmi $(head -1 new_image_id.txt)

        host: ${{ vars.HOST }}
        user: ${{ vars.SSH_USER }}
        key: ${{ secrets.SECRET_KEY }}

    - name: clean images
      uses: fifsky/ssh-action@master

      if: ${{ success() }}
      with:
        command: |
          cd dev/${{ github.event.repository.name }}
          docker rmi $(head -1 old_image_id.txt)

        host: ${{ vars.HOST }}
        user: ${{ vars.SSH_USER }}
        key: ${{ secrets.SECRET_KEY }}
